{
	"name": "UpsUserHistory",
	"properties": {
		"folder": {
			"name": "History/Ups"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"linkedService": {
						"referenceName": "ups_nonprodcn",
						"type": "LinkedServiceReference"
					},
					"name": "UpsUserHistoryQuery"
				}
			],
			"sinks": [
				{
					"name": "ExportBlob"
				}
			],
			"transformations": [
				{
					"name": "Transform"
				},
				{
					"name": "SelectColumns"
				}
			],
			"script": "source(output(\n\t\toid as long,\n\t\trev as long,\n\t\trevtype as short,\n\t\tbirthday as date,\n\t\tciam_id as string,\n\t\tcreated_at as timestamp,\n\t\tcreated_by as string,\n\t\temail as string,\n\t\tfirst_name as string,\n\t\tlandline_phone as string,\n\t\tlast_name1 as string,\n\t\tlast_name2 as string,\n\t\tmiddle_initial as string,\n\t\tmobile_phone as string,\n\t\tname_prefix as string,\n\t\tpreferred_language_code as string,\n\t\tsalutation_code as string,\n\t\ttitle as string,\n\t\tuser_id as string,\n\t\tverified_at as timestamp,\n\t\tverified_by as string,\n\t\taddress_line1 as string,\n\t\taddress_line2 as string,\n\t\taddress_line3 as string,\n\t\tcity as string,\n\t\tcountry_code as string,\n\t\tdoor_no as string,\n\t\tfloor_no as string,\n\t\thouse_name as string,\n\t\thouse_no as string,\n\t\tprovince as string,\n\t\tstate as string,\n\t\tstreet as string,\n\t\tstreet_type as string,\n\t\tzip_code as string,\n\t\tpobox as string,\n\t\tcontacted_by_email as boolean,\n\t\tcontacted_by_letter as boolean,\n\t\tcontacted_by_phone as boolean,\n\t\tcontacted_by_sms as boolean,\n\t\tis_mobile_ciam_verified as boolean,\n\t\tis_email_ciam_verified as boolean,\n\t\taccount_identifier as string,\n\t\tupdated_at as timestamp,\n\t\tvip as boolean,\n\t\tcase_number as string,\n\t\ttax_number as string,\n\t\tlower_email as string,\n\t\tnationality as string,\n\t\tmobile_phone_carrier as string,\n\t\tcitizenship_digital_certificate_carrier as string,\n\t\tdonate_gui as string,\n\t\te_gui_preference as string,\n\t\ttoas_accepted as boolean,\n\t\tidentification_number as string,\n\t\tidentification_type as string,\n\t\tplace_of_birth as string,\n\t\tgender_of_birth as string,\n\t\tid as long,\n\t\ttimestamp as long,\n\t\tusername as string,\n\t\tacting_user as string,\n\t\ttracking_id as string,\n\t\tservice_name as string,\n\t\tapplication_name as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'query',\n\tquery: 'SELECT * FROM user_profile_h uph INNER JOIN revision_info ri ON uph.rev = ri.id',\n\tstore: 'postgres',\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tbatchSize: 100000,\n\tpartitionBy('roundRobin', 20)) ~> UpsUserHistoryQuery\nUpsUserHistoryQuery derive(revision_timestamp = toDate(timestamp, 'yyyy-MM-dd'),\n\t\ttimestamp = toTimestamp(timestamp, 'yyyy-MM-dd HH:mm:ss'),\n\t\tpayload = '{'     \n    + '\"oid\": '+ coalesce(toString(oid),'0')\n    + ',\"userId\": \"'+ coalesce(user_id,'') + '\"' \n    + ',\"ciamId\": \"'+ coalesce(ciam_id,'') + '\"' \n    + ',\"createdAt\": \"'+ coalesce(toString(created_at),'') + '\"'\n    + ',\"lastName1\": \"'+ coalesce(last_name1,'') + '\"'\n    + ',\"lastName2\": \"'+ coalesce(last_name2,'') + '\"'\n    + ',\"landlinePhone\": \"'+ coalesce(landline_phone,'') + '\"'\n    + ',\"preferredLanguageCode\": \"'+ coalesce(preferred_language_code,'') + '\"' \n    + ',\"vip\": '+ coalesce(toString(vip),'false')\n    + ',\"toasAccepted\": '+ coalesce(toString(toas_accepted),'false')\n    + ',\"salutationCode\": \"'+ coalesce(salutation_code,'') + '\"'   \n    + ',\"email\": \"'+ coalesce(email,'') + '\"' \n    + ',\"lowerEmail\": \"'+ coalesce(lower_email,'') + '\"' \n    + ',\"mobilePhoneNumber\": \"'+ coalesce(mobile_phone,'') + '\"' \n    + ',\"createdBy\": \"'+ coalesce(created_by,'') + '\"' \n    + ',\"namePrefix\": \"'+ coalesce(name_prefix,'') + '\"' \n    + ',\"birthday\": \"'+ coalesce(toString(birthday),'') + '\"' \n    + ',\"verifiedBy\": \"'+ coalesce(verified_by,'') + '\"' \n    + ',\"middleInitial\": \"'+ coalesce(middle_initial,'') + '\"' \n    + ',\"verifiedAt\": \"'+ coalesce(toString(verified_at),'') + '\"'\n    + ',\"updatedAt\": \"'+ coalesce(toString(updated_at),'') + '\"' \n    + ',\"firstName\": \"'+ coalesce(first_name,'') + '\"' \n    + ',\"title\": \"'+ coalesce(toString(title),'') + '\"' \n    + ',\"taxNumber\": \"'+ coalesce(tax_number,'') + '\"' \n    + ',\"identificationNumber\": \"'+ coalesce(identification_number,'') + '\"' \n    + ',\"isMobileCiamVerified\": '+ coalesce(toString(is_mobile_ciam_verified),'false')\n    + ',\"isEmailCiamVerified\": '+ coalesce(toString(is_email_ciam_verified),'false') \n    + ',\"accountIdentifier\": \"'+ coalesce(account_identifier,'') + '\"'\n    + ',\"identificationType\": \"'+ coalesce(identification_type,'') + '\"' \n    + ',\"caseNumber\": \"'+ coalesce(case_number,'') + '\"' \n    + ',\"placeOfBirth\": \"'+ coalesce(place_of_birth,'') + '\"' \n    + ',\"genderOfBirth\": \"'+ coalesce(gender_of_birth,'') + '\"' \n    + ',\"mobilePhoneCarrier\": \"'+ coalesce(mobile_phone_carrier,'') + '\"'\n    + ',\"citizenshipDigitalCertificateCarrier\": \"'+ coalesce(citizenship_digital_certificate_carrier,'') + '\"' \n    + ',\"donateGui\": \"'+ coalesce(donate_gui,'') + '\"' \n    + ',\"eGuiPreference\": \"'+ coalesce(e_gui_preference,'') + '\"' \n    + ',\"address\": {'\n        + '\"floorNo\": \"'+ coalesce(floor_no,'') + '\"' \n        + ',\"street\": \"'+ coalesce(street,'') + '\"' \n        + ',\"houseNo\": \"'+ coalesce(house_no,'') + '\"' \n        + ',\"streetType\": \"'+ coalesce(street_type,'') + '\"' \n        + ',\"doorNo\": \"'+ coalesce(door_no,'') + '\"' \n        + ',\"addressLine1\": \"'+ coalesce(address_line1,'') + '\"' \n        + ',\"addressLine2\": \"'+ coalesce(address_line2,'') + '\"' \n        + ',\"addressLine3\": \"'+ coalesce(address_line3,'') + '\"' \n        + ',\"postOfficeBox\": \"'+ coalesce(pobox,'') + '\"' \n        + ',\"countryCode\": \"'+ coalesce(country_code,'') + '\"' \n        + ',\"zipCode\": \"'+ coalesce(zip_code,'') + '\"' \n        + ',\"city\": \"'+ coalesce(city,'') + '\"' \n        + ',\"province\": \"'+ coalesce(province,'') + '\"' \n        + ',\"state\": \"'+ coalesce(state,'') + '\"' \n        + ',\"houseName\": \"'+ coalesce(house_name,'') + '\"' \n    +'},\"communicationPreferences\": {'\n        + '\"contactedByPhone\": '+ coalesce(toString(contacted_by_phone),'false')\n        + ',\"contactedByLetter\": '+ coalesce(toString(contacted_by_letter),'false')\n        + ',\"contactedByEmail\": '+ coalesce(toString(contacted_by_email),'false')\n        + ',\"contactedBySms\": '+ coalesce(toString(contacted_by_sms),'false')\n    +'}'\n+'}',\n\t\theader = '{'     \n    + '\"X-RequestStartTime\": \"'+ coalesce(toString(timestamp),'') + '\"' \n    + ',\"X-ServiceName\": \"'+ coalesce(service_name,'') + '\"'\n    + ',\"X-ApplicationName\": \"'+ coalesce(application_name,'') + '\"'\n    + ',\"X-ActingUser\": \"'+ coalesce(acting_user,'') + '\"'\n    + ',\"X-TrackingId\": \"'+ coalesce(tracking_id,'') + '\"'\n+'}',\n\t\toperationType = case(revtype == 0, 'CREATE', \n    case(revtype == 2, 'DELETE',\n    'UPDATE'\n    )\n),\n\t\tdomainType = 'UserProfileHistory',\n\t\tmicroService = 'UPS') ~> Transform\nTransform select(mapColumn(\n\t\theader,\n\t\tpayload,\n\t\tmicroService,\n\t\toperationType,\n\t\tdomainType,\n\t\ttimestamp,\n\t\tbirthday,\n\t\tciamId = ciam_id,\n\t\tcreatedAt = created_at,\n\t\tcreatedBy = created_by,\n\t\temail,\n\t\tfirstName = first_name,\n\t\tlandlinePhone = landline_phone,\n\t\tlastName1 = last_name1,\n\t\tlastName2 = last_name2,\n\t\tmiddleInitial = middle_initial,\n\t\tmobilePhone = mobile_phone,\n\t\tnamePrefix = name_prefix,\n\t\tpreferredLanguageCode = preferred_language_code,\n\t\tsalutationCode = salutation_code,\n\t\ttitle,\n\t\tuserId = user_id,\n\t\tverifiedAt = verified_at,\n\t\tverifiedBy = verified_by,\n\t\taddressLine1 = address_line1,\n\t\taddressLine2 = address_line2,\n\t\taddressLine3 = address_line3,\n\t\tcity,\n\t\tdoorNo = door_no,\n\t\tfloorNo = floor_no,\n\t\thouseNo = house_no,\n\t\thouseName = house_name,\n\t\tprovince,\n\t\tstate,\n\t\tstreet,\n\t\tstreetType = street_type,\n\t\tzipCode = zip_code,\n\t\tpobox,\n\t\tcountryCode = country_code,\n\t\tcontactedByEmail = contacted_by_email,\n\t\tcontactedByLetter = contacted_by_letter,\n\t\tcontactedByPhone = contacted_by_phone,\n\t\tcontactedBySms = contacted_by_sms,\n\t\tisEmailCiamVerified = is_email_ciam_verified,\n\t\tisMobileCIamVerified = is_mobile_ciam_verified,\n\t\taccountIdentifier = account_identifier,\n\t\tupdatedAt = updated_at,\n\t\tvip,\n\t\tcaseNumber = case_number,\n\t\ttaxNumber = tax_number,\n\t\tidentificationNumber = identification_number,\n\t\tidentificationType = identification_type,\n\t\trevision_timestamp,\n\t\tdonateGui = donate_gui,\n\t\teGuiPreference = e_gui_preference,\n\t\tmobilePhoneCarrier = mobile_phone_carrier,\n\t\tplaceOfBirth = place_of_birth,\n\t\tgenderOfBirth = gender_of_birth,\n\t\tlowerEmail = lower_email,\n\t\tcitizenshipDigitalCertificateCarrier = citizenship_digital_certificate_carrier,\n\t\txTrackingId = tracking_id,\n\t\txServiceName = service_name,\n\t\txApplicationName = application_name,\n\t\txActingUser = acting_user,\n\t\ttoasAccepted = toas_accepted\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> SelectColumns\nSelectColumns sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\ttruncate: true,\n\tpartitionBy('key',\n\t\t0,\n\t\trevision_timestamp\n\t)) ~> ExportBlob"
		}
	}
}